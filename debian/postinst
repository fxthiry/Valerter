#!/bin/sh
set -e

case "$1" in
    configure)
        # Create system group if not exists
        if ! getent group valerter >/dev/null; then
            groupadd --system valerter
        fi
        # Create system user if not exists
        if ! id valerter >/dev/null 2>&1; then
            useradd --system --no-create-home --shell /usr/sbin/nologin --gid valerter valerter
        fi
        # Set ownership and permissions on config directory
        if [ -d /etc/valerter ]; then
            chown root:valerter /etc/valerter
            chmod 750 /etc/valerter
        fi
        # Set permissions on config file (contains secrets)
        if [ -f /etc/valerter/config.yaml ]; then
            chown root:valerter /etc/valerter/config.yaml
            chmod 640 /etc/valerter/config.yaml
        fi
        # Set permissions on templates directory
        if [ -d /etc/valerter/templates ]; then
            chown -R valerter:valerter /etc/valerter/templates
            chmod 755 /etc/valerter/templates
            find /etc/valerter/templates -type f -exec chmod 644 {} \;
        fi
        # Reload systemd (if available)
        if command -v systemctl >/dev/null 2>&1; then
            systemctl daemon-reload || true
            # Restart service on upgrade (not on fresh install)
            if [ -n "$2" ] && systemctl is-active --quiet valerter; then
                systemctl restart valerter || true
            fi
        fi
        ;;
esac

exit 0
