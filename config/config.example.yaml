# ==============================================================================
# Valerter Configuration Example
# ==============================================================================
# Copy to /etc/valerter/config.yaml and customize
#
# Quick Start: Uncomment and configure sections as needed.
# Minimal config requires: victorialogs.url, defaults, templates, rules
# ==============================================================================
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ CONFIGURATION APPROACHES                                                    │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │ ► RECOMMENDED (Simple deployments):                                         │
# │   Put all values directly in this file, including secrets.                  │
# │   Secure with: chmod 600 /etc/valerter/config.yaml                          │
# │                                                                             │
# │   webhook_url: "https://mattermost.example.com/hooks/abc123"                │
# │                                                                             │
# │ ► ALTERNATIVE (Kubernetes / Orchestrators):                                 │
# │   Use ${VAR_NAME} syntax for secrets. Variables are resolved at startup     │
# │   from the process environment (env vars, ConfigMaps, Secrets).             │
# │                                                                             │
# │   webhook_url: "${MATTERMOST_WEBHOOK}"                                      │
# │                                                                             │
# │ Both approaches can be mixed in the same config file.                       │
# └─────────────────────────────────────────────────────────────────────────────┘
# ==============================================================================

# ==============================================================================
# SECTION 1: VictoriaLogs Connection (REQUIRED)
# ==============================================================================
# Configure the connection to your VictoriaLogs instance.
# The URL is required; authentication and TLS are optional.

victorialogs:
  # REQUIRED: VictoriaLogs base URL (typically port 9428)
  url: "http://victorialogs:9428"

  # OPTIONAL: Basic Authentication
  # Generates 'Authorization: Basic ...' header automatically.
  # Recommended: use environment variables for credentials.
  # basic_auth:
  #   username: "${VL_USER}"       # REQUIRED if basic_auth is set
  #   password: "${VL_PASS}"       # REQUIRED if basic_auth is set

  # OPTIONAL: Custom HTTP headers
  # Use for Bearer tokens, API keys, or custom auth schemes.
  # headers:
  #   Authorization: "Bearer ${VL_TOKEN}"
  #   X-API-Key: "${VL_API_KEY}"

  # OPTIONAL: TLS configuration
  # tls:
  #   verify: true                 # Default: true. Set to false for self-signed certs (like curl -k)

# ==============================================================================
# SECTION 2: Metrics (OPTIONAL)
# ==============================================================================
# Prometheus metrics exposition. Exposes /metrics endpoint.
# Default: enabled=true, port=9090

metrics:
  enabled: true                    # Default: true
  port: 9090                       # Default: 9090

# ==============================================================================
# SECTION 3: Notifiers (OPTIONAL)
# ==============================================================================
# Named notification channels. Rules can target one or more notifiers.
# If omitted, falls back to MATTERMOST_WEBHOOK env var for backward compatibility.
#
# Supported types:
#   - mattermost: Mattermost incoming webhook
#   - webhook: Generic HTTP endpoint (PagerDuty, Slack, custom APIs)
#   - email: SMTP email notifications

# notifiers:
#   # --------------------------------------------------------------------------
#   # Mattermost Notifier
#   # --------------------------------------------------------------------------
#   # Required: webhook_url
#   # Optional: channel, username, icon_url
#
#   mattermost-ops:
#     type: mattermost
#     webhook_url: "https://mattermost.example.com/hooks/abc123"  # REQUIRED - direct value (recommended)
#     # OR: webhook_url: "${MATTERMOST_WEBHOOK}"                  # Alternative: env var for orchestrators
#     channel: ops-alerts                     # Optional: override default channel
#     username: valerter                      # Optional: webhook username
#     icon_url: "https://example.com/icon.png"  # Optional: webhook icon
#
#   # Minimal mattermost config (only webhook_url is required)
#   mattermost-minimal:
#     type: mattermost
#     webhook_url: "https://mattermost.example.com/hooks/xyz789"
#
#   # --------------------------------------------------------------------------
#   # Webhook Notifier (Generic HTTP)
#   # --------------------------------------------------------------------------
#   # Required: url
#   # Optional: method (default: POST), headers, body_template
#   #
#   # If body_template is omitted, sends default JSON payload:
#   # {
#   #   "alert_name": "<notifier_name>",
#   #   "rule_name": "...",
#   #   "title": "...",
#   #   "body": "...",
#   #   "color": "...",
#   #   "icon": "...",
#   #   "timestamp": "<ISO8601>"
#   # }
#
#   # Example: PagerDuty integration
#   pagerduty:
#     type: webhook
#     url: "https://events.pagerduty.com/v2/enqueue"
#     method: POST                            # Optional, default: POST
#     headers:
#       Authorization: "Token token=${PAGERDUTY_TOKEN}"
#       Content-Type: "application/json"
#     body_template: |
#       {
#         "routing_key": "${PAGERDUTY_ROUTING_KEY}",
#         "event_action": "trigger",
#         "payload": {
#           "summary": "{{ title }}",
#           "source": "valerter",
#           "severity": "error",
#           "custom_details": {
#             "body": "{{ body }}",
#             "rule": "{{ rule_name }}"
#           }
#         }
#       }
#
#   # Example: Slack webhook (minimal config)
#   slack-alerts:
#     type: webhook
#     url: "${SLACK_WEBHOOK_URL}"
#
#   # Example: Custom API with PUT method and auth header
#   custom-api:
#     type: webhook
#     url: "https://api.example.com/alerts"
#     method: PUT
#     headers:
#       Authorization: "Bearer ${API_TOKEN}"
#       X-Custom-Header: "valerter"
#     body_template: |
#       {"alert": "{{ title }}", "details": "{{ body }}"}
#
#   # --------------------------------------------------------------------------
#   # Email Notifier (SMTP)
#   # --------------------------------------------------------------------------
#   # Required: smtp (host, port), from, to, subject_template
#   # Optional: smtp.username, smtp.password, smtp.tls, smtp.tls_verify,
#   #           body_template, body_template_file
#   #
#   # TLS modes:
#   #   - none: No encryption (port 25, internal networks only)
#   #   - starttls: STARTTLS upgrade (port 587, recommended)
#   #   - tls: Direct TLS connection (port 465)
#   #
#   # Body templates:
#   #   - body_template: inline Jinja template string
#   #   - body_template_file: path to template file (relative to config or absolute)
#   #   - If neither is specified, a default HTML template is used
#   #   - Available variables: title, body, rule_name, color, icon
#
#   # Example: Full email config with authentication
#   email-ops:
#     type: email
#     smtp:
#       host: smtp.example.com               # REQUIRED
#       port: 587                            # REQUIRED (587=STARTTLS, 465=TLS, 25=none)
#       username: "${SMTP_USER}"             # Optional: SMTP auth username
#       password: "${SMTP_PASSWORD}"         # Optional: SMTP auth password
#       tls: starttls                        # Default: starttls. Options: none, starttls, tls
#       tls_verify: true                     # Default: true. Set false for self-signed certs
#     from: "valerter@example.com"           # REQUIRED
#     to:                                    # REQUIRED (at least one recipient)
#       - "ops@example.com"
#       - "admin@example.com"
#     subject_template: "[{{ rule_name | upper }}] {{ title }}"  # REQUIRED
#     # body_template_file: "templates/custom-email.html.j2"  # Optional: custom template
#     # Or inline:
#     # body_template: |
#     #   <html>
#     #     <body>
#     #       <h1>{{ title }}</h1>
#     #       <p>{{ body }}</p>
#     #       <small>Rule: {{ rule_name }}</small>
#     #     </body>
#     #   </html>
#
#   # Example: Minimal email config (internal network, no auth)
#   email-internal:
#     type: email
#     smtp:
#       host: internal-smtp.local
#       port: 25
#       tls: none
#       tls_verify: false
#     from: "alerts@internal.local"
#     to:
#       - "team@internal.local"
#     subject_template: "Alert: {{ title }}"

# ==============================================================================
# SECTION 4: Defaults (REQUIRED)
# ==============================================================================
# Default values applied to rules when not explicitly specified.

defaults:
  # REQUIRED: Default throttle settings
  throttle:
    count: 5                       # REQUIRED: Max alerts per window
    window: 60s                    # REQUIRED: Time window (e.g., 60s, 5m, 1h)

  # REQUIRED: Default notification settings
  notify:
    template: "default_alert"      # REQUIRED: Template name from templates section

# ==============================================================================
# SECTION 5: Templates (REQUIRED)
# ==============================================================================
# Reusable message templates for alert formatting.
# Uses Jinja2-like syntax (minijinja). Available variables depend on parser output.
# Built-in variables: title, body, rule_name, color, icon

templates:
  # Simple default template
  default_alert:
    title: "{{ title | default('Alert') }}"  # REQUIRED
    body: "{{ body }}"                        # REQUIRED
    color: "#ff0000"                          # Optional
    # icon: "warning"                         # Optional

  # Example: Template with conditional color
  custom_template:
    title: "{{ severity }}: {{ title }}"
    body: |
      **Host:** {{ host }}
      **Message:** {{ message }}
      **Time:** {{ timestamp }}
    color: "{{ '#ff0000' if severity == 'critical' else '#ffaa00' }}"
    icon: "warning"

# ==============================================================================
# SECTION 6: Rules (REQUIRED)
# ==============================================================================
# Alert rules define what logs to monitor and how to process them.
# At least one rule is required.

rules:
  # --------------------------------------------------------------------------
  # Example 1: JSON parser with per-host throttling
  # --------------------------------------------------------------------------
  - name: "high_cpu_alert"                   # REQUIRED: Unique rule name
    enabled: true                            # Default: true
    query: '_stream:{host="server1"} | json | cpu > 90'  # REQUIRED: LogsQL query
    parser:                                  # At least one of regex or json recommended
      json:
        fields: ["host", "cpu", "timestamp"]  # REQUIRED: Fields to extract from JSON
    throttle:                                # Optional: Overrides defaults.throttle
      key: "{{ host }}"                      # Optional: Group throttling by field value
      count: 3                               # REQUIRED if throttle is set
      window: 5m                             # REQUIRED if throttle is set
    notify:                                  # Optional: Overrides defaults.notify
      template: "default_alert"              # Optional: Template name
      # channel: "custom-channel"            # Optional: Override channel (legacy, prefer destinations)
      # destinations:                        # Optional: Send to specific notifiers
      #   - mattermost-ops                   # Must match names in notifiers section
      #   - email-ops

  # --------------------------------------------------------------------------
  # Example 2: Regex parser with default settings
  # --------------------------------------------------------------------------
  - name: "error_log_alert"
    enabled: true
    query: '_stream:{app="myapp"} level:error'
    parser:
      regex: '(?P<timestamp>\S+) (?P<level>\S+) (?P<message>.*)'  # Named capture groups
    # Uses defaults for throttle and notify

  # --------------------------------------------------------------------------
  # Example 3: Multi-destination routing
  # --------------------------------------------------------------------------
  # - name: "critical_error_alert"
  #   enabled: true
  #   query: '_stream:{app="myapp"} level:critical'
  #   parser:
  #     json:
  #       fields: ["message", "error", "stack_trace"]
  #   notify:
  #     template: "default_alert"
  #     destinations:                        # Send to multiple channels
  #       - mattermost-ops
  #       - email-ops
  #       - pagerduty

  # --------------------------------------------------------------------------
  # Example 4: Disabled rule (for reference or testing)
  # --------------------------------------------------------------------------
  - name: "disabled_example"
    enabled: false                           # Rule is ignored
    query: '_stream:{app="test"}'
    parser:
      json:
        fields: ["message"]

# ==============================================================================
# ENVIRONMENT VARIABLES REFERENCE
# ==============================================================================
#
# VictoriaLogs Authentication:
#   VL_USER         - Basic Auth username
#   VL_PASS         - Basic Auth password
#   VL_TOKEN        - Bearer token (for headers section)
#   VL_API_KEY      - API key (for headers section)
#
# Mattermost:
#   MATTERMOST_WEBHOOK - Legacy webhook URL (backward compatibility fallback)
#
# SMTP/Email:
#   SMTP_USER       - SMTP authentication username
#   SMTP_PASSWORD   - SMTP authentication password
#
# Logging:
#   RUST_LOG        - Log level: error, warn, info (default), debug, trace
#   LOG_FORMAT      - Output format: text (default), json
#
# ==============================================================================
