# Valerter Configuration Example
# Copy to /etc/valerter/config.yaml and customize
#
# Quick Start Authentication Examples (uncomment ONE):
#
# 1. Basic Auth:
#    basic_auth:
#      username: "${VL_USER}"
#      password: "${VL_PASS}"
#
# 2. Bearer Token:
#    headers:
#      Authorization: "Bearer ${VL_TOKEN}"
#
# 3. Self-signed certificate:
#    tls:
#      verify: false

# VictoriaLogs connection settings
victorialogs:
  url: "http://victorialogs:9428"

  # ===== OPTIONAL: Authentication Options =====

  # Basic Auth (optional) - generates Authorization header automatically
  # Recommended: use environment variables for credentials
  # basic_auth:
  #   username: "${VL_USER}"
  #   password: "${VL_PASS}"

  # Custom headers (optional) - for tokens, API keys, etc.
  # Values should use environment variables for security
  # headers:
  #   Authorization: "Bearer ${VL_TOKEN}"
  #   X-API-Key: "${VL_API_KEY}"

  # TLS configuration (optional)
  # tls:
  #   verify: true    # Set to false for self-signed certificates (like curl -k)

# Metrics exposition settings
metrics:
  enabled: true       # Enable Prometheus metrics endpoint
  port: 9090          # Port for /metrics endpoint

# ============================================================
# Notifiers Configuration (Story 6.2, 6.5)
# ============================================================
# Define named notifiers for sending alerts.
# Each notifier has a unique name and type-specific configuration.
#
# Supported types:
#   - mattermost: Send alerts to Mattermost via incoming webhook
#   - webhook: Send alerts to any HTTP endpoint (Story 6.5)
#
# If this section is omitted, valerter falls back to MATTERMOST_WEBHOOK
# environment variable for backward compatibility.

# notifiers:
#   # ===== Mattermost Notifier =====
#   mattermost-infra:
#     type: mattermost
#     webhook_url: "${MATTERMOST_WEBHOOK_INFRA}"  # Use env vars for secrets!
#     channel: infra-alerts                        # Optional: override channel
#     username: valerter-infra                     # Optional: webhook username
#     icon_url: "https://example.com/icon.png"    # Optional: webhook icon
#
#   mattermost-ops:
#     type: mattermost
#     webhook_url: "${MATTERMOST_WEBHOOK_OPS}"
#     channel: ops-alerts
#
#   # Minimal config - only webhook_url is required
#   mattermost-default:
#     type: mattermost
#     webhook_url: "${MATTERMOST_WEBHOOK}"
#
#   # ===== Generic Webhook Notifier (Story 6.5) =====
#   # Send alerts to any HTTP endpoint with custom headers and body
#
#   # Example: PagerDuty integration
#   pagerduty:
#     type: webhook
#     url: "https://events.pagerduty.com/v2/enqueue"
#     method: POST                                  # Optional: POST (default), PUT
#     headers:
#       Authorization: "Token token=${PAGERDUTY_TOKEN}"
#       Content-Type: "application/json"
#     body_template: |
#       {
#         "routing_key": "${PAGERDUTY_ROUTING_KEY}",
#         "event_action": "trigger",
#         "payload": {
#           "summary": "{{ title }}",
#           "source": "valerter",
#           "severity": "error",
#           "custom_details": {
#             "body": "{{ body }}",
#             "rule": "{{ rule_name }}"
#           }
#         }
#       }
#
#   # Example: Slack webhook (minimal config)
#   slack-alerts:
#     type: webhook
#     url: "${SLACK_WEBHOOK_URL}"
#     # Without body_template, sends default JSON payload:
#     # {
#     #   "alert_name": "slack-alerts",
#     #   "rule_name": "...",
#     #   "title": "...",
#     #   "body": "...",
#     #   "color": "...",
#     #   "icon": "...",
#     #   "timestamp": "2026-01-12T14:30:00Z"
#     # }
#
#   # Example: Custom API with auth header
#   custom-api:
#     type: webhook
#     url: "https://api.example.com/alerts"
#     method: PUT
#     headers:
#       Authorization: "Bearer ${API_TOKEN}"
#       X-Custom-Header: "valerter"
#     body_template: |
#       {"alert": "{{ title }}", "details": "{{ body }}"}

# Default values applied to rules when not specified
defaults:
  throttle:
    count: 5          # Max alerts per window
    window: 60s       # Time window for throttling
  notify:
    template: "default_alert"

# Reusable message templates
templates:
  default_alert:
    title: "{{ title | default('Alert') }}"
    body: "{{ body }}"
    color: "#ff0000"

  custom_template:
    title: "{{ severity }}: {{ title }}"
    body: |
      **Host:** {{ host }}
      **Message:** {{ message }}
      **Time:** {{ timestamp }}
    color: "{{ '#ff0000' if severity == 'critical' else '#ffaa00' }}"
    icon: "warning"

# Alert rules
rules:
  - name: "high_cpu_alert"
    enabled: true
    query: '_stream:{host="server1"} | json | cpu > 90'
    parser:
      json:
        fields: ["host", "cpu", "timestamp"]
    throttle:
      key: "{{ host }}"      # Group throttling by host
      count: 3               # Max 3 alerts
      window: 5m             # Per 5 minutes
    notify:
      template: "default_alert"
      # destinations: Send to multiple notifiers (Story 6.3)
      # If omitted, uses default notifier. Must match names from notifiers: section.
      # Example:
      #   destinations:
      #     - mattermost-infra
      #     - mattermost-ops

  - name: "error_log_alert"
    enabled: true
    query: '_stream:{app="myapp"} level:error'
    parser:
      regex: '(?P<timestamp>\S+) (?P<level>\S+) (?P<message>.*)'
    # Uses defaults for throttle and notify (including default notifier)

  # Example: Rule with multi-destination routing (Story 6.3)
  # - name: "critical_error_alert"
  #   enabled: true
  #   query: '_stream:{app="myapp"} level:critical'
  #   parser:
  #     json:
  #       fields: ["message", "error"]
  #   notify:
  #     template: "default_alert"
  #     destinations:
  #       - mattermost-infra    # Send to infra team
  #       - mattermost-ops      # Also send to ops team

  - name: "disabled_example"
    enabled: false
    query: '_stream:{app="test"}'
    parser:
      json:
        fields: ["message"]

# Environment variables:
#
# Notification (pick ONE method):
# - notifiers: section in config (recommended - supports multiple notifiers)
# - MATTERMOST_WEBHOOK: Legacy webhook URL (backward compatible fallback)
#
# VictoriaLogs Authentication (optional):
# - VL_USER: VictoriaLogs Basic Auth username
# - VL_PASS: VictoriaLogs Basic Auth password
# - VL_TOKEN: VictoriaLogs Bearer token (use in headers section)
# - VL_API_KEY: VictoriaLogs API key (use in headers section)
#
# Notifier Webhooks (for use in notifiers: section):
# - MATTERMOST_WEBHOOK_INFRA: Webhook URL for infra alerts
# - MATTERMOST_WEBHOOK_OPS: Webhook URL for ops alerts
# - etc. (use ${VAR_NAME} syntax in webhook_url field)
#
# Logging:
# - RUST_LOG: Log level (default: info)
# - LOG_FORMAT: Log output format - "text" (default) or "json"
#               Use "json" for log aggregation systems (Loki, ELK, etc.)
#               Use "text" for journalctl and human reading
