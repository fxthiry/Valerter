# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                         VALERTER CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Copy this file to /etc/valerter/config.yaml and customize.
#
# Required sections: victorialogs, defaults, templates, notifiers, rules
# Optional section:  metrics
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SECRETS MANAGEMENT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Option 1 - Direct values (simple deployments):
#   Secure with: chmod 600 /etc/valerter/config.yaml
#   webhook_url: "https://mattermost.example.com/hooks/abc123"
#
# Option 2 - Environment variables (Kubernetes, orchestrators):
#   Variables resolved at startup from process environment.
#   webhook_url: "${MM_WEBHOOK}"
#
# Both approaches can be mixed in the same file.
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MULTI-FILE CONFIGURATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Split configuration into .d/ directories for large deployments:
#
#   /etc/valerter/
#   â”œâ”€â”€ config.yaml
#   â”œâ”€â”€ rules.d/
#   â”‚   â”œâ”€â”€ security.yaml
#   â”‚   â””â”€â”€ infra.yaml
#   â”œâ”€â”€ templates.d/
#   â”‚   â””â”€â”€ custom.yaml
#   â””â”€â”€ notifiers.d/
#       â””â”€â”€ team-channels.yaml
#
# In .d/ files, the resource name is the YAML key (not a field):
#
#   # rules.d/security.yaml
#   auth_failure:                          # â† Rule name
#     query: "_msg:authentication failed"
#     parser:
#       json:
#         fields:
#           - user
#           - ip
#     notify:
#       template: default_alert
#       destinations:
#         - slack-security
#
# Names must be unique across all files. Collisions produce explicit errors.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ VICTORIALOGS CONNECTION                                          [REQUIRED]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

victorialogs:
  url: "http://127.0.0.1:9428"

  # â”€â”€ Authentication (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #
  # basic_auth:
  #   username: "${VL_USER}"
  #   password: "${VL_PASS}"
  #
  # headers:                               # For Bearer tokens or API keys
  #   Authorization: "Bearer ${VL_TOKEN}"

  # â”€â”€ TLS (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #
  # tls:
  #   verify: true                         # Set false for self-signed certs


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ DEFAULTS                                                         [REQUIRED]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

defaults:
  throttle:
    count: 5                               # Max alerts per window
    window: 60s                            # Duration: 30s, 5m, 1h, etc.

  timestamp_timezone: "UTC"       # IANA timezone for log_timestamp_formatted
                                           # Examples: UTC, America/New_York, Asia/Tokyo


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ TEMPLATES                                                        [REQUIRED]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# Message templates using Jinja2 syntax (minijinja).
#
# Built-in variables:
#   rule_name                - Name of the triggered rule
#   log_timestamp            - Original log timestamp (ISO8601)
#   log_timestamp_formatted  - Human-readable timestamp (uses defaults.timestamp_timezone)
#
# Parser variables:
#   Any field extracted by the rule's parser (JSON fields or regex named groups)
#
# Fields:
#   title        - Alert title (required)
#   body         - Alert body, plain text or Markdown (required)
#   body_html    - HTML version for email (optional, falls back to body)
#   accent_color - Hex color for visual indicators (optional, e.g., "#ff0000")

templates:
  default_alert:
    title: "{{ title | default('Alert') }}"
    body: "{{ body }}"
    accent_color: "#3498db"

  # â”€â”€ Example: Severity-based template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #
  # critical_alert:
  #   title: "ğŸ”´ CRITICAL: {{ title }}"
  #   body: |
  #     **Host:** {{ host }}
  #     **Message:** {{ message }}
  #   body_html: |
  #     <h2 style="color: red;">{{ title }}</h2>
  #     <p><strong>Host:</strong> {{ host }}</p>
  #     <p>{{ message }}</p>
  #   accent_color: "#e74c3c"


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ NOTIFIERS                                                        [REQUIRED]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# At least one notifier must be configured.
# Rules reference notifiers by name in their destinations list.

notifiers:

  # â”€â”€ Mattermost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Incoming webhook integration.
  #
  # Required: webhook_url
  # Optional: channel (override default), username, icon_url

  mattermost-ops:
    type: mattermost
    webhook_url: "https://mattermost.example.com/hooks/xxx"
    # channel: alerts
    # username: valerter
    # icon_url: "https://example.com/icon.png"

  # â”€â”€ Webhook (Generic HTTP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Send alerts to any HTTP endpoint (Slack, PagerDuty, custom APIs).
  #
  # Required: url
  # Optional: method (default: POST), headers, body_template
  #
  # Default payload when body_template is omitted:
  # {
  #   "alert_name": "<notifier_name>",
  #   "rule_name": "...",
  #   "title": "...",
  #   "body": "...",
  #   "timestamp": "<ISO8601>",
  #   "log_timestamp": "<ISO8601>",
  #   "log_timestamp_formatted": "DD/MM/YYYY HH:MM:SS TZ"
  # }

  # slack-alerts:
  #   type: webhook
  #   url: "${SLACK_WEBHOOK_URL}"

  # pagerduty:
  #   type: webhook
  #   url: "https://events.pagerduty.com/v2/enqueue"
  #   headers:
  #     Authorization: "Token token=${PAGERDUTY_TOKEN}"
  #     Content-Type: "application/json"
  #   body_template: |
  #     {
  #       "routing_key": "${PAGERDUTY_ROUTING_KEY}",
  #       "event_action": "trigger",
  #       "payload": {
  #         "summary": "{{ title }}",
  #         "source": "valerter",
  #         "severity": "error",
  #         "custom_details": {
  #           "body": "{{ body }}",
  #           "rule": "{{ rule_name }}"
  #         }
  #       }
  #     }

  # â”€â”€ Email (SMTP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Required: smtp.host, smtp.port, from, to, subject_template
  # Optional: smtp.username, smtp.password, smtp.tls, smtp.tls_verify,
  #           body_template (inline), body_template_file (path)
  #
  # TLS modes:
  #   none     - No encryption (port 25, internal networks only)
  #   starttls - STARTTLS upgrade (port 587, recommended)
  #   tls      - Direct TLS (port 465)
  #
  # If no body template is specified, a default HTML template is used.

  # email-ops:
  #   type: email
  #   smtp:
  #     host: smtp.example.com
  #     port: 587
  #     username: "${SMTP_USER}"
  #     password: "${SMTP_PASSWORD}"
  #     tls: starttls                      # Default: starttls
  #     tls_verify: true                   # Default: true
  #   from: "valerter@example.com"
  #   to:
  #     - "ops@example.com"
  #     - "admin@example.com"
  #   subject_template: "[{{ rule_name | upper }}] {{ title }}"
  #   body_template: |                     # Optional: inline HTML body
  #     <h2>{{ title }}</h2>
  #     <p>{{ body }}</p>
  #   # body_template_file: /etc/valerter/email-template.html  # Or: external file


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ RULES                                                            [REQUIRED]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# At least one rule must be configured.
#
# Fields:
#   name         - Unique identifier (required)
#   query        - LogsQL query (required)
#   parser       - Data extraction config (required, see below)
#   notify       - Notification settings (required)
#   enabled      - Enable/disable rule (optional, default: true)
#   throttle     - Override default throttle (optional)
#
# Parser (at least one of regex or json should be configured):
#   json.fields  - List of JSON fields to extract
#   regex        - Pattern with named capture groups: (?P<name>pattern)

rules:
  # â”€â”€ Example 1: JSON logs with per-host throttling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: high_cpu_alert
    # enabled: false                       # Optional: disable rule (default: true)
    query: '_stream:{host="server1"} AND _msg:"cpu" | json | cpu:>90'
    parser:
      json:
        fields:
          - host
          - cpu
          - timestamp
    throttle:
      key: "{{ host }}"                    # Throttle independently per host
      count: 3
      window: 5m
    notify:
      template: default_alert
      destinations:
        - mattermost-ops

  # â”€â”€ Example 2: Regex parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: error_log_alert
    query: '_stream:{app="myapp"} AND level:error'
    parser:
      regex: '(?P<timestamp>\S+) (?P<level>\S+) (?P<message>.*)'
    notify:
      template: default_alert
      # mattermost_channel: custom-channel # Override notifier's default channel
      destinations:
        - mattermost-ops

  # â”€â”€ Example 3: Multi-destination routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #
  # - name: critical_alert
  #   query: '_stream:{app="myapp"} AND level:critical'
  #   parser:
  #     json:
  #       fields:
  #         - message
  #         - stack_trace
  #   notify:
  #     template: critical_alert
  #     destinations:
  #       - mattermost-ops
  #       - email-ops
  #       - pagerduty


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ METRICS                                                          [OPTIONAL]â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# Prometheus metrics exposition at /metrics endpoint.

metrics:
  enabled: true                            # Default: true
  port: 9090                               # Default: 9090


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENVIRONMENT VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Use ${VAR_NAME} syntax anywhere in this file to reference environment variables.
# Any variable from the process environment can be used (no predefined list).
#
# Examples used in this file:
#   ${VL_USER}, ${VL_PASS}     - VictoriaLogs credentials
#   ${VL_TOKEN}                - Bearer token for VictoriaLogs
#   ${SMTP_USER}, ${SMTP_PASSWORD} - Email credentials
#   ${SLACK_WEBHOOK_URL}       - Slack webhook
#   ${PAGERDUTY_TOKEN}         - PagerDuty API token
#
# Runtime variables (not substituted in config, read directly by the process):
#   RUST_LOG   - Log level: error, warn, info (default), debug, trace
#   LOG_FORMAT - Output format: text (default), json
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
